<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RealVibe</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.worldcoin.org/minikit/v1/minikit.js"></script>

<style>
body{font-family:'Plus Jakarta Sans',sans-serif;background:#f8f9fa;}
.gradient{background:linear-gradient(135deg,#ff69b4,#8a2be2);}
.card{position:absolute;width:100%;height:100%;border-radius:20px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.1);background:#fff;touch-action:none;}
</style>
</head>
<body>

<div class="max-w-md mx-auto p-4">

<div class="flex justify-between items-center mb-4">
<h1 class="text-2xl font-bold gradient text-transparent bg-clip-text">RealVibe</h1>
<button id="verifyBtn" class="gradient text-white px-3 py-2 rounded-xl text-sm">Verify</button>
</div>

<!-- Swipe Area -->
<div class="relative h-[500px] mb-4" id="swipeArea"></div>

<div class="flex justify-between items-center">
<button id="rewind" class="bg-gray-200 px-4 py-2 rounded-full">⟲</button>
<button id="dislike" class="bg-red-100 text-red-500 px-6 py-3 rounded-full">✕</button>
<button id="superlike" class="bg-blue-100 text-blue-500 px-6 py-3 rounded-full">★</button>
<button id="like" class="gradient text-white px-6 py-3 rounded-full">♥</button>
<button id="boost" class="bg-yellow-100 text-yellow-500 px-4 py-2 rounded-full">⚡</button>
</div>

<!-- Chat -->
<div class="mt-6 bg-white p-4 rounded-2xl shadow">
<h2 class="font-bold mb-2">Chat</h2>
<div id="messages" class="h-40 overflow-y-auto border rounded-xl p-2 mb-2"></div>
<input id="msgInput" class="w-full border p-2 rounded-xl mb-2" placeholder="Message...">
<button id="sendMsg" class="w-full gradient text-white p-2 rounded-xl">Send</button>
</div>

</div>

<script>
// SUPABASE
const supabase = window.supabase.createClient(
'https://bogcdpwnnjxfgfdcewif.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZ2NkcHdubmp4ZmdmZGNld2lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTM2MjgsImV4cCI6MjA4Njg2OTYyOH0.65pFiqgEmjogf73mZCG-yT2BZqx6Q8cbA_Ce9RhnIhQ'
)

let verified=false
let premium=false
let swipeCount=0
let profiles=[]
let currentIndex=0

// VERIFY WORLD ID
document.getElementById("verifyBtn").onclick=async()=>{
const result=await MiniKit.verify({action:"realvibe-verify"})
if(result.success){verified=true;alert("World ID Verified")}
}

// PAYMENTS
async function pay(amount){
const res=await MiniKit.pay({
to:"0xdf4a991bc05945bd0212e773adcff6ea619f4c4b",
tokens:[{symbol:"WLD",amount:amount}]
})
return res.success
}

// LOAD PROFILES
async function loadProfiles(){
const {data}=await supabase.from("profiles").select("*")
profiles=data||[]
renderCards()
}

function renderCards(){
const area=document.getElementById("swipeArea")
area.innerHTML=""
profiles.slice(currentIndex,currentIndex+3).reverse().forEach((p,i)=>{
const card=document.createElement("div")
card.className="card p-4"
card.style.zIndex=i
card.innerHTML=`
<img src="${p.photos?.[0]||''}" class="w-full h-72 object-cover rounded-xl mb-3">
<h3 class="text-xl font-bold">${p.name||''}, ${p.age||''}</h3>
<p class="text-gray-600">${p.bio||''}</p>
`
area.appendChild(card)
addSwipe(card,p)
})
}

function addSwipe(card,profile){
let startX=0
card.addEventListener("touchstart",e=>startX=e.touches[0].clientX)
card.addEventListener("touchmove",e=>{
let moveX=e.touches[0].clientX-startX
card.style.transform=`translateX(${moveX}px) rotate(${moveX/10}deg)`
})
card.addEventListener("touchend",async e=>{
let moveX=e.changedTouches[0].clientX-startX
if(moveX>120) await like(profile)
else if(moveX<-120) await dislike(profile)
card.style.transform=""
})
}

// LIKE / DISLIKE
async function like(profile){
if(!premium && swipeCount>=10) return alert("Daily limit reached")
swipeCount++
await supabase.from("likes").insert({to_user:profile.id})
next()
}

async function dislike(profile){
if(!premium && swipeCount>=10) return alert("Daily limit reached")
swipeCount++
next()
}

function next(){
currentIndex++
renderCards()
}

// BUTTONS
document.getElementById("like").onclick=()=>like(profiles[currentIndex])
document.getElementById("dislike").onclick=()=>dislike(profiles[currentIndex])

document.getElementById("superlike").onclick=async()=>{
if(await pay(1)){
await supabase.from("likes").insert({to_user:profiles[currentIndex].id,super:true})
next()
}
}

document.getElementById("boost").onclick=async()=>{
if(await pay(5)) alert("Boost activated")
}

document.getElementById("rewind").onclick=()=>{
if(currentIndex>0){currentIndex--;renderCards()}
}

// CHAT REALTIME
supabase.channel("chat")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{
const msg=document.createElement("div")
msg.textContent=payload.new.content
document.getElementById("messages").appendChild(msg)
})
.subscribe()

document.getElementById("sendMsg").onclick=async()=>{
const content=document.getElementById("msgInput").value
await supabase.from("messages").insert({content})
document.getElementById("msgInput").value=""
}

loadProfiles()
</script>

</body>
</html>
